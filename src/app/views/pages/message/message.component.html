<app-horizontal-app-menu
  [showSearch]="true"
  [showIcon]="true"
  [navClass]="'navbar navbar-expand-lg'"
  style="display: contents"
  [headerClass]="'navbar-light fixed-top header-static bg-mode'"
/>

<main class="content">
  <div class="container">
    <div class="row gx-0">
      <div class="col-lg-4 col-xxl-3" id="chatTabs" role="tablist">
        <div class="d-flex align-items-center mb-4 d-lg-none">
          <button
            class="border-0 bg-transparent"
            type="button"
            (click)="open()"
            data-bs-toggle="offcanvas"
            data-bs-target="#offcanvasNavbar"
            aria-controls="offcanvasNavbar"
          >
            <span class="btn btn-primary"
              ><i class="fa-solid fa-sliders-h"></i
            ></span>
            <span class="h6 mb-0 fw-bold d-lg-none ms-2">Chats</span>
          </button>
        </div>
        <div
          class="card card-body border-end-0 border-bottom-0 rounded-bottom-0"
        >
          <div class="d-flex justify-content-between align-items-center">
            <h1 class="h5 mb-0">
              Active chats
              <span class="badge bg-success bg-opacity-10 text-success">6</span>
            </h1>

            <div class="dropend position-relative">
              <div class="nav">
                <a
                  class="icon-md rounded-circle btn btn-sm btn-primary-soft nav-link toast-btn"
                  data-target="chatToast"
                  href="javascript:void(0);"
                >
                  <i class="bi bi-pencil-square"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
        <nav class="navbar navbar-light navbar-expand-lg mx-0">
          <div
            class="offcanvas offcanvas-start"
            tabindex="-1"
            id="offcanvasNavbar"
          >
            <div class="offcanvas-header">
              <button
                type="button"
                (click)="close()"
                class="btn-close text-reset ms-auto"
                data-bs-dismiss="offcanvas"
              ></button>
            </div>
            <div class="offcanvas-body p-0">
              <div
                class="card card-chat-list rounded-end-lg-0 card-body border-end-lg-0 rounded-top-0"
              >
                <form class="position-relative">
                  <input
                    class="form-control py-2"
                    type="search"
                    placeholder="Search for chats"
                    aria-label="Search"
                  />
                  <button
                    class="btn bg-transparent text-secondary px-2 py-0 position-absolute top-50 end-0 translate-middle-y"
                    type="submit"
                  >
                    <i class="bi bi-search fs-5"></i>
                  </button>
                </form>
                <div class="mt-4 h-100">
                  <div
                    overlay-scrollbars
                    class="chat-tab-list custom-scrollbar"
                  >
                    <ul
                      ngbNav
                      #nav="ngbNav"
                      class="nav flex-column nav-pills nav-pills-soft"
                    >
                      @for (item of allchats; track $index; let last = $last) {
                        <li data-bs-dismiss="offcanvas" ngbNavItem>
                          <a
                            href="#chat-1"
                            (click)="selectChat(item)"
                            ngbNavLink
                            class="nav-link text-start"
                            id="chat-1-tab"
                            data-bs-toggle="pill"
                            role="tab"
                          >
                            <div class="d-flex">
                              <div
                                class="flex-shrink-0 avatar avatar-story me-2"
                                [ngClass]="{
                                  'status-online': item.status === 'online',
                                  'avatar-story': item.isStory === true,
                                  'status-offline': item.status === 'offline',
                                }"
                              >
                                <img
                                  class="avatar-img rounded-circle"
                                  [src]="item.image"
                                  alt=""
                                />
                              </div>
                              <div class="flex-grow-1 d-block">
                                <h6 class="mb-0 mt-1">{{ item.name }}</h6>
                                <div
                                  class="small text-secondary text-truncate"
                                  style="max-width: 120px"
                                >
                                  {{ getLastMessage(item) }}
                                </div>
                              </div>
                            </div>
                          </a>
                          <ng-template ngbNavContent>
                            <div
                              class="fade tab-pane show h-100"
                              id="chat-1"
                              role="tabpanel"
                              aria-labelledby="chat-1-tab"
                            >
                              <div
                                class="d-sm-flex justify-content-between align-items-center"
                              >
                                <div class="d-flex mb-2 mb-sm-0">
                                  <div class="flex-shrink-0 avatar me-2">
                                    <img
                                      class="avatar-img rounded-circle"
                                      [src]="item.image"
                                      alt=""
                                    />
                                  </div>
                                  <div class="d-block flex-grow-1">
                                    <h6 class="mb-0 mt-1">{{ item.name }}</h6>
                                    <div class="small text-secondary">
                                      @if (item.statusText) {
                                        {{ item.statusText }}
                                      }
                                      @if (item.status) {
                                        <i
                                          class="fa-solid fa-circle me-1"
                                          [ngClass]="
                                            item.status === 'offline'
                                              ? 'text-danger'
                                              : 'text-success'
                                          "
                                        ></i
                                        >{{ item.status | titlecase }}
                                      }
                                    </div>
                                  </div>
                                </div>
                                <div class="d-flex align-items-center">
                                  <a
                                    href="javascript:void(0);"
                                    class="icon-md rounded-circle btn btn-primary-soft me-2 px-2"
                                    placement="top"
                                    ngbTooltip="Audio call"
                                    ><i class="bi bi-telephone-fill"></i
                                  ></a>
                                  <a
                                    href="javascript:void(0);"
                                    class="icon-md rounded-circle btn btn-primary-soft me-2 px-2"
                                    placement="top"
                                    ngbTooltip="Video call"
                                    ><i class="bi bi-camera-video-fill"></i
                                  ></a>

                                  <div class="dropdown" ngbDropdown>
                                    <a
                                      class="icon-md rounded-circle btn btn-primary-soft me-2 px-2 arrow-none"
                                      ngbDropdownToggle
                                      href="javascript:void(0);"
                                      id="chatcoversationDropdown"
                                      role="button"
                                      data-bs-toggle="dropdown"
                                      data-bs-auto-close="outside"
                                      aria-expanded="false"
                                      ><i class="bi bi-three-dots-vertical"></i
                                    ></a>
                                    <ul
                                      class="dropdown-menu dropdown-menu-end"
                                      aria-labelledby="chatcoversationDropdown"
                                      ngbDropdownMenu
                                    >
                                      <li>
                                        <a
                                          class="dropdown-item"
                                          href="javascript:void(0);"
                                          ><i
                                            class="bi bi-check-lg me-2 fw-icon"
                                          ></i
                                          >Mark as read</a
                                        >
                                      </li>
                                      <li>
                                        <a
                                          class="dropdown-item"
                                          href="javascript:void(0);"
                                          ><i
                                            class="bi bi-mic-mute me-2 fw-icon"
                                          ></i
                                          >Mute conversation</a
                                        >
                                      </li>
                                      <li>
                                        <a
                                          class="dropdown-item"
                                          href="javascript:void(0);"
                                          ><i
                                            class="bi bi-person-check me-2 fw-icon"
                                          ></i
                                          >View profile</a
                                        >
                                      </li>
                                      <li>
                                        <a
                                          class="dropdown-item"
                                          href="javascript:void(0);"
                                          ><i
                                            class="bi bi-trash me-2 fw-icon"
                                          ></i
                                          >Delete chat</a
                                        >
                                      </li>
                                      <li class="dropdown-divider"></li>
                                      <li>
                                        <a
                                          class="dropdown-item"
                                          href="javascript:void(0);"
                                          ><i
                                            class="bi bi-archive me-2 fw-icon"
                                          ></i
                                          >Archive chat</a
                                        >
                                      </li>
                                    </ul>
                                  </div>
                                </div>
                              </div>

                              <hr />

                              <div
                                overlay-scrollbars
                                class="chat-conversation-content custom-scrollbar"
                                style="height: calc(100vh - 350px)"
                              >
                                @for (msg of item.messages; track $index) {
                                  @if (msg.sendAt) {
                                    <div class="text-center small my-2">
                                      {{ msg.sendAt }}
                                    </div>
                                  }

                                  @if (msg.isSender === true) {
                                    <div
                                      class="d-flex justify-content-end text-end mb-1"
                                    >
                                      <div class="w-100">
                                        @if (msg.msg.img) {
                                          <div
                                            class="d-flex flex-column align-items-end"
                                          >
                                            <img
                                              class="rounded h-200px"
                                              src="assets/images/avatar/05.jpg"
                                              alt=""
                                            />
                                            <div class="small my-2">
                                              {{ msg.timeStamp }}
                                            </div>
                                          </div>
                                        } @else {
                                          <div
                                            class="d-flex flex-column align-items-end"
                                          >
                                            <div
                                              class="bg-primary text-white p-2 px-3 rounded-2"
                                            >
                                              {{ msg.msg.text }}
                                            </div>
                                            @if (msg.isRead) {
                                              <div class="d-flex my-2">
                                                <div
                                                  class="small text-secondary"
                                                >
                                                  {{ msg.timeStamp }}
                                                </div>
                                                <div class="small ms-2">
                                                  <i
                                                    class="fa-solid fa-check-double text-info"
                                                  ></i>
                                                </div>
                                              </div>
                                            }
                                          </div>
                                        }
                                      </div>
                                    </div>
                                  } @else {
                                    <div class="d-flex mb-1">
                                      <div
                                        class="flex-shrink-0 avatar avatar-xs me-2"
                                      >
                                        <img
                                          class="avatar-img rounded-circle"
                                          [src]="item.image"
                                          alt=""
                                        />
                                      </div>
                                      <div class="flex-grow-1">
                                        <div class="w-100">
                                          <div
                                            class="d-flex flex-column align-items-start"
                                          >
                                            @if (msg.msg.isEmoji) {
                                              <div
                                                class="bg-light text-secondary p-2 px-3 rounded-2"
                                              >
                                                <p class="small mb-0">
                                                  Congratulations:)
                                                </p>
                                                <div
                                                  class="card shadow-none p-2 border border-2 rounded mt-2"
                                                >
                                                  <img
                                                    src="assets/images/elements/14.svg"
                                                    alt=""
                                                  />
                                                </div>
                                              </div>
                                            } @else {
                                              <div
                                                class="bg-light text-secondary p-2 px-3 rounded-2"
                                              >
                                                {{ msg.msg.text }}
                                              </div>
                                            }
                                            <div class="small my-2">
                                              {{ msg.timeStamp }}
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  }
                                }
                              </div>
                            </div>
                          </ng-template>
                        </li>
                      }
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </nav>
      </div>

      <div class="col-lg-8 col-xxl-9">
        <div class="card card-chat rounded-start-lg-0 border-start-lg-0">
          <div class="card-body">
            <div
              class="tab-content py-0 mb-0"
              [ngbNavOutlet]="nav"
              id="chatTabsContent"
            ></div>
          </div>
          <div class="card-footer">
            <form
              [formGroup]="formData"
              (ngSubmit)="messageSend()"
              class="d-sm-flex align-items-end"
            >
              <input
                class="form-control mb-sm-0 mb-3"
                formControlName="message"
                data-autoresize
                placeholder="Type a message"
              />
              <button class="btn btn-sm btn-danger-soft ms-sm-2">
                <i class="fa-solid fa-face-smile fs-6"></i>
              </button>
              <button class="btn btn-sm btn-secondary-soft ms-2">
                <i class="fa-solid fa-paperclip fs-6"></i>
              </button>
              <button type="submit" class="btn btn-sm btn-primary ms-2">
                <i class="fa-solid fa-paper-plane fs-6"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
